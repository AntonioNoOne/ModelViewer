<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IMI Academy - Visualizzatore AR</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --imi-black: #000000;
        --imi-white: #ffffff;
        --imi-orange: #FF6B35;
        --imi-orange-light: #FF8C61;
        --imi-gray: #F5F5F5;
        --imi-gray-dark: #333333;
        --imi-gray-light: #E0E0E0;
        --imi-text-primary: #000000;
        --imi-text-secondary: #666666;
      }

      body {
        margin: 0;
        background: var(--imi-white);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: 100vh;
        padding: 0;
        position: relative;
        overflow-x: hidden;
        color: var(--imi-text-primary);
      }

      .header {
        width: 100%;
        background: var(--imi-white);
        padding: 1.5rem 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        position: relative;
        z-index: 10;
        border-bottom: 1px solid var(--imi-gray-light);
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .logo-section {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .logo-img {
        height: 45px;
        width: auto;
        object-fit: contain;
      }

      .logo-text {
        color: var(--imi-black);
        font-size: 1.8rem;
        font-weight: 700;
        letter-spacing: -0.5px;
        display: none; /* Nascondi il testo se c'√® il logo */
      }

      .logo-accent {
        color: var(--imi-orange);
      }

      .back-button {
        padding: 0.75rem 1.5rem;
        background: var(--imi-white);
        color: var(--imi-text-primary);
        border: 1px solid var(--imi-gray-light);
        border-radius: 4px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .back-button:hover {
        transform: translateY(-1px);
        border-color: var(--imi-orange);
        color: var(--imi-orange);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .container {
        width: 100%;
        max-width: 1200px;
        padding: 2rem 1rem;
        position: relative;
        z-index: 1;
      }

      .model-container {
        width: 100%;
        background: var(--imi-white);
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        border: 1px solid var(--imi-gray-light);
      }

      .model-title {
        width: 100%;
        text-align: center;
        margin-bottom: 1.5rem;
        color: var(--imi-text-primary);
        font-size: 2rem;
        font-weight: 600;
        letter-spacing: -0.5px;
      }

      model-viewer {
        width: 100%;
        height: 70vh;
        min-height: 400px;
        border-radius: 4px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--imi-gray-light);
      }

      .ar-launcher {
        margin-top: 2rem;
        padding: 1rem 2rem;
        background: var(--imi-black);
        color: var(--imi-white);
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        max-width: 400px;
        text-transform: uppercase;
        letter-spacing: 1px;
        position: relative;
        overflow: hidden;
      }

      .ar-launcher::before {
        content: '‚Üí';
        margin-right: 0.5rem;
        font-size: 1.1rem;
      }

      .ar-launcher:hover {
        transform: translateY(-2px);
        background: var(--imi-orange);
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
      }

      .ar-launcher:active {
        transform: translateY(0);
      }

      .info-badge {
        margin-top: 1.5rem;
        padding: 1rem;
        background: var(--imi-gray);
        border: 1px solid var(--imi-gray-light);
        border-radius: 4px;
        color: var(--imi-text-secondary);
        font-size: 0.9rem;
        text-align: center;
        max-width: 500px;
        line-height: 1.6;
      }

      .info-badge strong {
        color: var(--imi-text-primary);
      }

      @media (max-width: 768px) {
        .header {
          padding: 1rem;
        }

        .logo-text {
          font-size: 1.4rem;
        }

        .header-content {
          flex-direction: column;
          align-items: stretch;
        }

        .back-button {
          width: 100%;
          justify-content: center;
        }

        model-viewer {
          height: 60vh;
          min-height: 300px;
        }

        .model-container {
          padding: 1.5rem;
        }

        .model-title {
          font-size: 1.4rem;
        }

        .ar-launcher {
          font-size: 1rem;
          padding: 1rem 2rem;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="header-content">
        <div class="logo-section">
          <img src="assets/Imi_logo.png" alt="IMI Academy" class="logo-img">
          <div class="logo-text">
            IMI <span class="logo-accent">Academy</span>
          </div>
        </div>
        <a href="index.html" class="back-button">
          ‚Üê Torna alla Selezione
        </a>
      </div>
    </header>

    <div class="container">
      <div class="model-container">
        <div class="model-title" id="modelTitle">Caricamento modello...</div>
        
        <model-viewer
          id="model3D"
          src=""
          alt="Modello 3D"
          ar
          ar-modes="scene-viewer webxr quick-look"
          auto-rotate
          camera-controls
          shadow-intensity="1"
          exposure="1"
          reveal="auto"
        >
        </model-viewer>

        <button class="ar-launcher" onclick="launchAR()">
          Visualizza in AR
        </button>

        <div class="info-badge">
          <strong>üí° Suggerimento:</strong> Usa il pulsante AR per visualizzare il modello nella realt√† aumentata. 
          Ruota e ingrandisci il modello usando i controlli touch o mouse.
        </div>
      </div>
    </div>

    <script>
      // Funzione per inizializzare il visualizzatore
      function initViewer() {
        // Prova prima localStorage (fallback per problemi con redirect del server)
        let modelFile = localStorage.getItem('selectedModel');
        let iosFile = localStorage.getItem('selectedModelIOS');
        const modelName = localStorage.getItem('selectedModelName');
        
        if (modelFile) {
          // Pulisci localStorage dopo aver letto
          localStorage.removeItem('selectedModel');
          localStorage.removeItem('selectedModelIOS');
          localStorage.removeItem('selectedModelName');
        } else {
          // Se non in localStorage, prova dai parametri URL
          const urlParams = new URLSearchParams(window.location.search);
          modelFile = urlParams.get('model');
          iosFile = urlParams.get('ios');
        }

        const modelViewer = document.getElementById('model3D');
        const modelTitle = document.getElementById('modelTitle');

        if (!modelViewer || !modelTitle) {
          console.error('Elementi DOM non trovati!');
          return;
        }

        // Mappa dei nomi dei modelli (supporta sia percorsi relativi che solo nomi file)
        const modelNames = {
          'modelli/glb/ScarponeMoonBoot.glb': 'Scarpone MoonBoot',
          'ScarponeMoonBoot.glb': 'Scarpone MoonBoot',
          'modelli/glb/ScarpaImy.glb': 'Scarpa Imy',
          'ScarpaImy.glb': 'Scarpa Imy',
          'modelli/glb/ScarpaProva.glb': 'Scarpa Prova',
          'ScarpaProva.glb': 'Scarpa Prova',
          'modelli/glb/Model.glb': 'Modello Generico',
          'Model.glb': 'Modello Generico'
        };

        if (modelFile && modelFile.trim() !== '') {
          modelViewer.setAttribute('src', modelFile);
          if (iosFile && iosFile.trim() !== '') {
            modelViewer.setAttribute('ios-src', iosFile);
          }
          
          // Imposta il titolo (usa quello da localStorage se disponibile, altrimenti dalla mappa)
          let displayName = modelName;
          if (!displayName) {
            // Prova prima con il percorso completo, poi solo con il nome file
            displayName = modelNames[modelFile] || modelNames[modelFile.split('/').pop()];
            if (!displayName) {
              // Estrai solo il nome file senza estensione
              const fileName = modelFile.split('/').pop().replace('.glb', '').replace('.usdz', '');
              displayName = fileName;
            }
          }
          modelTitle.textContent = displayName;

          // Gestisci errori di caricamento
          modelViewer.addEventListener('error', (e) => {
            console.error('Errore nel caricamento del modello:', e);
            modelTitle.textContent = 'Errore nel caricamento del modello';
            modelTitle.style.color = '#ef4444';
          });
        } else {
          modelTitle.textContent = 'Nessun modello selezionato';
          modelTitle.style.color = '#ef4444';
          
          // Redirect alla home dopo 2 secondi
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000);
        }
      }

      function launchAR() {
        const modelViewer = document.getElementById('model3D');
        if (modelViewer && modelViewer.activateAR) {
          modelViewer.activateAR();
        } else {
          alert("La modalit√† AR non √® supportata sul tuo dispositivo.");
        }
      }

      // Inizializza quando il DOM √® pronto
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initViewer);
      } else {
        initViewer();
      }
    </script>
  </body>
</html>
